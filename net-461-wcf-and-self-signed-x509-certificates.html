<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>
    .NET 4.6.1, WCF and self signed X509 certificates - news.ciandcd.com</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="http://ciandcd.github.io/theme/css/bootstrap.css" rel="stylesheet" type="text/css"/>
  <link href="http://ciandcd.github.io/theme/css/main.css" rel="stylesheet" type="text/css"/>
  <link href="http://ciandcd.github.io/theme/css/pygment.css" rel="stylesheet" type="text/css"/>
  <link href="http://fonts.googleapis.com/css?family=Chelsea+Market" rel="stylesheet" type="text/css"/>

<script src="http://ciandcd.github.io/theme/tipuesearch/tipuesearch_content.js"></script>
<link href="http://ciandcd.github.io/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
<script src="http://ciandcd.github.io/theme/tipuesearch/tipuesearch_set.js"></script>
<script src="http://ciandcd.github.io/theme/tipuesearch/tipuesearch.min.js"></script>
<link href="http://ciandcd.github.io/feeds/rss.xml" rel="alternate" type="application/atom+xml" title="news.ciandcd.com RSS" />
<script>
$(document).ready(function() {
     $('#tipue_search_input').tipuesearch({
          'mode': 'json',
          'contentLocation': 'tipuesearch_content.json'
     });
});
</script>


  <!--[if lt IE 9]>
    <script src="https://raw.github.com/aFarkas/html5shiv/master/dist/html5shiv.js"></script>
  <![endif]-->
</head>

<!--
bootstrap-itech - a Pelican theme using Bootstrap
-->
<body>

<!-- Header -->
<header>
<div class="container-fluid">
<h1 class="page-header"><a href="http://ciandcd.github.io/index.html">news.ciandcd.com </a>
<h4>软件持续集成和发布</h4></h1>
</div>
</header>
<!-- /Header -->

<nav class="navbar navbar-default">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://ciandcd.github.io/index.html"></a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

  <li><a href="http://ciandcd.github.io/index.html">首页</a></li>

  <li class="active"><a href="http://ciandcd.github.io/category/ciandcd.html">ciandcd</a></li>
  <li ><a href="http://ciandcd.github.io/category/devops.html">devops</a></li>
  <li ><a href="http://ciandcd.github.io/category/scm.html">scm</a></li>

  
    <li ><a href="http://ciandcd.github.io/pages/about.html">about</a></li>
    <li ><a href="http://ciandcd.github.io/pages/awesome.html">Awesome</a></li>


</ul>
      <form class="navbar-form navbar-left navbar-search" role="search" action="http://ciandcd.github.io/search.html onsubmit="return validateForm(this.elements['q'].value);">
        <div class="form-group search-query">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
      </form>

      <ul class="nav navbar-nav navbar-right">
        <li><a href="http://www.cnblogs.com/itech">itech</a></li>
        <li><a href="https://github.com/ciandcd">Github</a></li>
      </ul>

    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

<!-- Body -->
<section id="body">
<div class="container">

<!-- Nav bar -->
<!-- /Nav bar -->

<!-- Main block -->
<div class="row">

<!-- Content -->
<div class="col-lg-9">
<article>
<h2>
    .NET 4.6.1, WCF and self signed X509 certificates</h2>
From:<a href="https://www.finalbuilder.com/resources/blogs/postid/746/net-461-wcf-and-self-signed-x509-certificates">https://www.finalbuilder.com/resources/blogs/postid/746/net-461-wcf-and-self-signed-x509-certificates</a><br><br><div><br><br>
If you use self signed X509 certificates and target the .net framework 4.6.1 then you are in some fun, especially if you used makecert to generate the certificate. There is a change in behaviour in the way certificates are validated, which will leave you pulling you hair out for hours. The error you may encounter will look something like this :&#160;<br><br>
"The Identity check failed for the outgoing message. The remote endpoint did not provide a domain name system (DNS) claim and therefore did not satisfied DNS identity 'localhost'. This may be caused by lack of DNS or CN name in the remote endpoint X.509 certificate's distinguished name."<br><br>
If you google the error message, you will find plenty of references to using&#160; a DnsEndpointIdentity, only in our case, we were already doing exactly as the answers on stackoverflow were suggesting! Since we were migrating from .net 4.0 to .net 4.6.1, I started looking for info on the changes in each version of the .net framework. Eventually, I came across this page :<br><br><a class="moz-txt-link-freetext" href="https://msdn.microsoft.com/en-us/library/mt620030%28v=vs.110%29.aspx">https://msdn.microsoft.com/en-us/library/mt620030(v=vs.110).aspx</a><br><br>
This was the only mention of X509 certificates I could find in the change history, but it seems like it could be related, so I tried what it suggested, and low and behold, problem solved! With some further investigation of this work around, I found some issueson the wcf github repo with several references to the behaviour of certificate validation.<br><br><a class="moz-txt-link-freetext" href="https://github.com/dotnet/wcf/issues/321">https://github.com/dotnet/wcf/issues/321</a><br><br><a class="moz-txt-link-freetext" href="https://github.com/dotnet/wcf/pull/603">https://github.com/dotnet/wcf/pull/603</a><br><br>
So it turns out, in .NET 4.6.1 they broke the certificate validation, by only looking at the Subject Alternate Name (SAN) extension, and not falling back to the Subject Name CN field as it should. The pull request I linked to above, is for the WCF for .NET core, not 4.6.1 - so I have no way of knowing if this will be fixed for 4.6.x. &#160;<br><br>
Whilst an app.config change can work around the issue, the real fix is to generate certificates that include SAN extension.<br><br><h3>Generating a certificate without MakeCert</h3>
<p>Makecert.exe, which is commonly used (on windows at least) does not support the SAN extension, M</p>akecert is deprecated, so it's unlikely there will be an update to make it able to generate certificates with the SAN certificate extension. &#160;Windows 8/Server 2012R2 &amp; later versions of Windows include a new powershell cmdlet to generate certificates. For Windows 7 the best option is this :<br><br><a class="moz-txt-link-freetext" href="https://gallery.technet.microsoft.com/scriptcenter/Self-signed-certificate-5920a7c6">https://gallery.technet.microsoft.com/scriptcenter/Self-signed-certificate-5920a7c6</a><br><br>
This appears to what the Windows 8 &amp; later cmdlet is based on, it's relatively simple to use and generates certificates that validate properly with WCF on .NET 4.6.1<br><br><pre class="brush:powershell; toolbar:true;">New-SelfSignedCertificateEx -Subject "CN=MyServer" -KeySpec Exchange 
-KeyUsage "DataEncipherment, KeyEncipherment, DigitalSignature" 
-Path c:\certs\example.pfx -Exportable -SAN "MyServer" -SignatureAlgorithm sha256 
-AllowSMIME -Password (ConvertTo-SecureString "abc123dontuseme" -AsPlainText -Force) 
-NotAfter (get-date).AddYears(20)</pre>
<br>
Note the above command is on multiple lines to make it easier to read, it can be on one line.
<br><br><br> &#13;
                    <p>We have been working on moving Continua CI to .net 4.6.1 for a future release, and during this conversion (so far, mostly just updating nuget packages), we discovered an issue that turned out to be caused by a change to .net certificate validation.If you use self signed X509 certificates and target the .net framework 4.6.1 then you are in some fun, especially if you used makecert to generate the certificate. There is a change in behaviour in the way certificates are validated, which will leave you pulling you hair out for hours. The error you may encounter will look something like this :"The Identity check failed for the outgoing message. The remote endpoint did not provide a domain name system (DNS) claim and therefore did not satisfied DNS identity 'localhost'. This may be caused by lack of DNS or CN name in the remote endpoint X.509 certificate's distinguished name."If you google the error message, you will find plenty of references to using a DnsEndpointIdentity, only in our case, we were already doing exactly as the answers on stackoverflow were suggesting! Since we were migrating from .net 4.0 to .net 4.6.1, I started looking for info on the changes in each version of the .net framework. Eventually, I came across this page :This was the only mention of X509 certificates I could find in the change history, but it seems like it could be related, so I tried what it suggested, and low and behold, problem solved! With some further investigation of this work around, I found some issueson the wcf github repo with several references to the behaviour of certificate validation.So it turns out, in .NET 4.6.1 they broke the certificate validation, by only looking at the Subject Alternate Name (SAN) extension, and not falling back to the Subject Name CN field as it should. The pull request I linked to above, is for the WCF for .NET core, not 4.6.1 - so I have no way of knowing if this will be fixed for 4.6.x.Whilst an app.config change can work around the issue, the real fix is to generate certificates that include SAN extension.akecert is deprecated, so it's unlikely there will be an update to make it able to generate certificates with the SAN certificate extension. Windows 8/Server 2012R2 &amp; later versions of Windows include a new powershell cmdlet to generate certificates. For Windows 7 the best option is this :This appears to what the Windows 8 &amp; later cmdlet is based on, it's relatively simple to use and generates certificates that validate properly with WCF on .NET 4.6.1Note the above command is on multiple lines to make it easier to read, it can be on one line.</p></div>

<p class="info">
<h4>
Posted Sun 15 May 2016
 by <a class="url fn" href="http://ciandcd.github.io/author/itech001.html">itech001</a>
in <a href="http://ciandcd.github.io/category/ciandcd.html">ciandcd</a>
(<a href="http://ciandcd.github.io/tag/finalbuilder.html">finalbuilder</a>)</h4></p>

</article>
</div>
<!-- /Content -->

<!-- Side bar -->
<nav class="col-lg-3">

<h2>分类</h2>
<ul class="nav nav-pills nav-stacked">
  <li class="active"><a href="http://ciandcd.github.io/category/ciandcd.html">ciandcd</a></li>
  <li ><a href="http://ciandcd.github.io/category/devops.html">devops</a></li>
  <li ><a href="http://ciandcd.github.io/category/scm.html">scm</a></li>
</ul>

<h2>标签</h2>
<ul class="tagcloud">
        <li class="tag-1"><a href="http://ciandcd.github.io/tag/finalbuilder.html">finalbuilder</a></li>
        <li class="tag-1"><a href="http://ciandcd.github.io/tag/jenkins.html">jenkins</a></li>
        <li class="tag-1"><a href="http://ciandcd.github.io/tag/devops.html">devops</a></li>
        <li class="tag-2"><a href="http://ciandcd.github.io/tag/ciandcd.html">ciandcd</a></li>
        <li class="tag-2"><a href="http://ciandcd.github.io/tag/perforce.html">perforce</a></li>
</ul>

<h2>链接</h2>
<ul class="nav nav-pills nav-stacked">
  <li><a href="http://www.cnblogs.com/itech/">itech</a></li>
  <li><a href="http://www.ciandcd.com">ciandcd</a></li>
</ul>

<h2>联系</h2>
<ul class="nav nav-pills nav-stacked">
  <li><a href="http://ciandcd.github.io/feeds/rss.xml" type="application/rss+xml" rel="alternate">Site Feed</a></li>
  <li><a href="https://github.com/ciandcd">Github</a></li>
</ul>

<h2>作者</h2>
<ul class="nav nav-pills nav-stacked">
  <li ><a href="http://ciandcd.github.io/author/about-the-author.html">About The Author</a></li>
  <li ><a href="http://ciandcd.github.io/author/alex-staveley.html">Alex Staveley</a></li>
  <li ><a href="http://ciandcd.github.io/author/antti-virtanen.html">Antti Virtanen</a></li>
  <li ><a href="http://ciandcd.github.io/author/barton-george.html">Barton George</a></li>
  <li ><a href="http://ciandcd.github.io/author/elizabeth-geno.html">Elizabeth Geno</a></li>
  <li ><a href="http://ciandcd.github.io/author/florian-motlik.html">Florian Motlik</a></li>
  <li ><a href="http://ciandcd.github.io/author/gene-kim.html">Gene Kim</a></li>
  <li ><a href="http://ciandcd.github.io/author/itech001.html">itech001</a></li>
  <li ><a href="http://ciandcd.github.io/author/jez-humble.html">Jez Humble</a></li>
  <li ><a href="http://ciandcd.github.io/author/john-cook.html">John Cook</a></li>
  <li ><a href="http://ciandcd.github.io/author/john-esser.html">John Esser</a></li>
  <li ><a href="http://ciandcd.github.io/author/jules-louis.html">Jules Louis</a></li>
  <li ><a href="http://ciandcd.github.io/author/jullietta-jung.html">Jullietta Jung</a></li>
  <li ><a href="http://ciandcd.github.io/author/kobi-halperin.html">Kobi Halperin</a></li>
  <li ><a href="http://ciandcd.github.io/author/meta-brown.html">Meta Brown</a></li>
  <li ><a href="http://ciandcd.github.io/author/michelle-d-souza.html">Michelle D Souza</a></li>
  <li ><a href="http://ciandcd.github.io/author/nathaniel-eliot.html">Nathaniel Eliot</a></li>
  <li ><a href="http://ciandcd.github.io/author/patrik-carlos.html">Patrik Carlos</a></li>
  <li ><a href="http://ciandcd.github.io/author/peter-spung.html">Peter Spung</a></li>
  <li ><a href="http://ciandcd.github.io/author/piotr-oktaba.html">Piotr Oktaba</a></li>
  <li ><a href="http://ciandcd.github.io/author/ragnar-lonn.html">Ragnar Lönn</a></li>
  <li ><a href="http://ciandcd.github.io/author/ralph-tice.html">Ralph Tice</a></li>
  <li ><a href="http://ciandcd.github.io/author/scuzza-man.html">Scuzza Man</a></li>
  <li ><a href="http://ciandcd.github.io/author/sven-malvik.html">Sven Malvik</a></li>
  <li ><a href="http://ciandcd.github.io/author/tony-bradley.html">Tony Bradley</a></li>
  <li ><a href="http://ciandcd.github.io/author/william-pietri.html">William Pietri</a></li>
  <li ><a href="http://ciandcd.github.io/author/yegor-bugayenko.html">Yegor Bugayenko</a></li>
</ul>

</nav>
<!-- /Side bar -->

</div>
<!-- /Main block -->

<!-- Footer -->
<div class="row"><div class="col-lg-12">
<footer><small>
软件持续集成和持续发布 QQ群：172758282. <a target="_blank" href="http://shang.qq.com/wpa/qunwpa?idkey=d15cb26237b499f41b21a6e95ddc436766a383a725106a92bd69cdf860a64d34"><img border="0" src="http://pub.idqqimg.com/wpa/images/group.png" alt="ciandcd.com" title="ciandcd.com"></a>
</small></footer>
</div></div>
<!-- /Footer -->

</div></section>
<!-- /Body -->

<script src="http://ciandcd.github.io/theme/js/jquery.js"></script>
<script src="http://ciandcd.github.io/theme/js/bootstrap.js"></script>


</body>
</html>