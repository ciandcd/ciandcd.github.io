<!DOCTYPE html>
    <html lang="zh-cn">
    <head>
    <meta charset="utf-8"/>
    <title>
    <meta name="date" content=""/>Organisation Pattern: Trunk Based Development</title></head><body>from:http://java.dzone.com/articles/organisation-pattern-trunk-based-development<br><div><p class="print-link"></p><p>Trunk Based Development is a version control strategy in which developers commit their changes to the shared trunk of a source code repository with minimal branching. Trunk Based Development became well known in the mid 2000s as&#160;<a href="http://www.martinfowler.com/articles/continuousIntegration.html">Continuous Integration</a>&#160;became a mainstream development practice, and today it is equally applicable to centralised Version Control Systems (VCS) and Distributed Version Control Systems (DVCS).</p><p>In Trunk Based Development new features are developed concurrently on trunk as a series of small, incremental steps that preserve existing functionality and minimise merge complexity. Features are always released from trunk, and defect fixes are either released from trunk or a short-lived release branch.</p><p>When development of a feature spans multiple releases its entry point is concealed to ensure the ongoing changes do not impede release cadence. The addition of a new feature can be concealed with a&#160;<a href="http://www.martinfowler.com/bliki/FeatureToggle.html">Feature Toggle</a>, which means a configuration parameter or business rule is used to turn a feature on or off at runtime. As shown below&#160;a&#160;Feature Toggle is turned off while its feature is in development (v1), turned on when its feature is in production (v2), and removed after a period of time (v3).</p><p><a href="http://www.alwaysagileconsulting.com/blog/wp-content/uploads/2015/04/Organisation-Pattern-Trunk-Based-Development-Feature-Toggle-Step-By-Step.png"><img class="aligncenter wp-image-4456" src="http://www.alwaysagileconsulting.com/blog/wp-content/uploads/2015/04/Organisation-Pattern-Trunk-Based-Development-Feature-Toggle-Step-By-Step.png" alt="Organisation Pattern - Trunk Based Development - Feature Toggle Step By Step" width="650" height="208"></a></p><p>Updates to an existing feature can be concealed with a&#160;<a href="http://martinfowler.com/bliki/BranchByAbstraction.html">Branch By Abstraction</a>, which means an&#160;abstraction layer is temporarily introduced to encapsulate both the old behaviour in use and the new behaviour in development. As shown below a&#160;Branch By Abstraction&#160;routes requests to the old behaviour while the new behaviour is in development (v1-v2), reroutes requests to the new behaviour when it is in production (v3), and is removed after a period of time (v4).</p><p><a href="http://www.alwaysagileconsulting.com/blog/wp-content/uploads/2015/04/Organisation-Pattern-Trunk-Based-Development-Branch-By-Abstraction-Step-By-Step.png"><img class="aligncenter wp-image-4458" src="http://www.alwaysagileconsulting.com/blog/wp-content/uploads/2015/04/Organisation-Pattern-Trunk-Based-Development-Branch-By-Abstraction-Step-By-Step.png" alt="Organisation Pattern - Trunk Based Development - Branch By Abstraction Step By Step" width="650" height="223"></a></p><p>Trunk Based Development is synonymous with Continuous Integration, which has been described by Jez Humble et al as &#8220;<a href="http://www.amazon.co.uk/dp/1449368425">the most important technical practice in the agile canon</a>&#8220;. Continuous Integration is a development practice where&#160;all members of a team integrate and test their changes together on at least a daily basis, resulting in a shared mindset of collaboration and an always releasable codebase. This is verified by an automated build server continuously building the latest changes, and can include pre- and post-build actions such as code reviews and auto-revert on failure.</p><p>Consider an organisation that provides an online Company Accounts Service, with its codebase maintained by a team practicing Trunk Based Development and Continuous Integration. In iteration 1&#160;two features are requested &#8211; F1 Computations and F2 Write Offs &#8211; so the team discuss their concurrent development&#160;and decide on a&#160;Feature Toggle for F1 as it is a larger change. The developers commit their changes for F1 and F2 to trunk multiple times a day, with F1 tested in its on and off states to verify its progress alongside F2.</p><p><a href="http://www.alwaysagileconsulting.com/blog/wp-content/uploads/2015/06/Organisation-Pattern-Trunk-Based-Development-Trunk-Based-Development-1.png"><img class="aligncenter wp-image-4464" src="http://www.alwaysagileconsulting.com/blog/wp-content/uploads/2015/06/Organisation-Pattern-Trunk-Based-Development-Trunk-Based-Development-1.png" alt="Organisation Pattern - Trunk Based Development - Trunk Based Development 1" width="882" height="450"></a></p><p>In iteration 2 more features &#8211; F3 Bank Details and F4 Accounting Periods &#8211; begin development. F4 requires a different downstream submissions system, so the team design&#160;a Branch By Abstraction for submissions to ensure F1 and F3 can continue with the legacy&#160;submissions system until F4 is complete.&#160;F2 is signed off and released into production with F1 still toggled off at runtime. Some changes for F3 break the build, which triggers an automatic revert and a team discussion on a better design for F3.</p><p><a href="http://www.alwaysagileconsulting.com/blog/wp-content/uploads/2015/06/Organisation-Pattern-Trunk-Based-Development-Trunk-Based-Development-2.png"><img class="aligncenter wp-image-4465" src="http://www.alwaysagileconsulting.com/blog/wp-content/uploads/2015/06/Organisation-Pattern-Trunk-Based-Development-Trunk-Based-Development-2.png" alt="Organisation Pattern - Trunk Based Development - Trunk Based Development 2" width="882" height="450"></a></p><p>In iteration 3 a&#160;production defect is found in F2, and after the defect is fixed on trunk a release branch is agreed for risk mitigation. An F2.1 release branch is created from the last commit of the&#160;F2&#160;release,&#160;the&#160;fix is merged to the branch, and F2.1 is released into production. F4 continues on trunk, with the&#160;submissions Branch By Abstraction tested in both modes. F3 is signed off and released into production using the legacy submissions system.</p><p><a href="http://www.alwaysagileconsulting.com/blog/wp-content/uploads/2015/06/Organisation-Pattern-Trunk-Based-Development-Trunk-Based-Development-3.png"><img class="aligncenter wp-image-4466" src="http://www.alwaysagileconsulting.com/blog/wp-content/uploads/2015/06/Organisation-Pattern-Trunk-Based-Development-Trunk-Based-Development-3.png" alt="Organisation Pattern - Trunk Based Development - Trunk Based Development 3" width="882" height="450"></a></p><p>In iteration 4&#160;F1 is signed off and its Feature Toggle is turned on in production following a release. F4 is signed off and released into production, but when the Branch By Abstraction is switched to the&#160;new submissions system a defect is found. As a result the Branch By Abstraction is reverted at runtime to the legacy submissions system, and a F4.1 fix is&#160;released from trunk.</p><p><a href="http://www.alwaysagileconsulting.com/blog/wp-content/uploads/2015/06/Organisation-Pattern-Trunk-Based-Development-Trunk-Based-Development-4.png"><img class="aligncenter wp-image-4467" src="http://www.alwaysagileconsulting.com/blog/wp-content/uploads/2015/06/Organisation-Pattern-Trunk-Based-Development-Trunk-Based-Development-4.png" alt="Organisation Pattern - Trunk Based Development - Trunk Based Development 4" width="882" height="450"></a></p><p>In this example F1, F2, F3, and F4 clearly benefit from being developed by a team collaborating on a single shared code stream. For F1 the team agrees on the why and how of the Feature Toggle, with F1 tested in both its on and off states. For F2 the defect fix is made available from trunk and everyone is aware of the decision to use a release branch for risk mitigation. For F3 the prominence of a reverted build failure encourages people to contribute to a better design. For F4 there is a team&#160;decision&#160;to create a submissions Branch By Abstraction, with the new abstraction layer offering fresh insights into the legacy system and incremental commits enabling regular feedback on the new approach. Furthermore, when the new submissions system is switched on and a defect is found in F4 the ability to revert at runtime to the legacy submissions means the Company Accounts Service can remain online with zero downtime.</p><p>This&#160;highlights the advantages of Trunk Based Development:</p><ul><li>Continuous Integration &#8211; incremental commits to trunk ensure an&#160;always&#160;integrated, always tested codebase with minimal integration costs and a predictable flow of features</li><li>Adaptive scheduling &#8211; an always releasable codebase separates the release schedule from development efforts, meaning features can be released on demand&#160;according to customer needs</li><li>Collaborative design &#8211; everyone working&#160;on&#160;the same code encourages constant communication,&#160;with team members sharing responsibility for design changes and a cohesive&#160;<a href="http://www.ibm.com/developerworks/java/library/j-eaed1/index.html">Evolutionary Architecture</a></li><li>Operational and business empowerment&#160;&#8211;&#160;techniques such as&#160;Feature Toggle and Branch By Abstraction decouple release from launch, providing&#160;the operational benefit of graceful degradation&#160;on failure and the business benefit of&#160;<a href="http://www.informit.com/articles/article.aspx?p=1833567&amp;seqNum=2">Dark Launching</a>&#160;features</li></ul><p>Breaking down features and re-architecting an existing system in incremental&#160;steps requires discipline, planning, and ingenuity from an entire team on a daily basis, and Trunk Based Development can incur a development overhead for some time if multiple technologies are in play and/or the codebase is poorly structured. However, those&#160;additional efforts&#160;will substantially reduce integration costs and gradually push&#160;the codebase in the right&#160;direction &#8211; as shown&#160;by Dave Farley and Jez Humble praising Trunk Based Development for &#8220;<a href="http://www.amazon.co.uk/dp/0321601912">the gentle, subtle pressure it applies to make the design of your software better</a>&#8220;.</p><p>A common misconception of Trunk Based Development is that it is slow, as features take longer to complete and team velocity is&#160;often lower than expected. However, an organisation should optimise globally for cycle time not locally for velocity, and by mandating a single code stream Trunk Based Development ensures developers work at the maximum rate of the team not the individual, with reduced integration costs resulting in lower lead times.</p><p>Trunk Based Development is&#160;simple, but not easy. It has a steep learning curve but the continuous integration&#160;of&#160;small changesets into trunk&#160;will minimise integration costs,&#160;encourage collaborative design, empower runtime&#160;operational and business decisions, and&#160;ultimately drive the engine of Continuous&#160;Delivery. It is for this reason Dave Farley and Jez Humble&#160;declared&#160;&#8220;<a href="http://www.amazon.co.uk/dp/0321601912">we can&#8217;t emphasise enough how important this practice is in enabling continuous delivery of valuable, working software</a>&#8220;.</p>	
	<p></p>

    </div></body></html>